<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{components/headfragment :: head(titulo='Ejercicios')}"></head>

<body>

<header th:replace="components/cabeceraFrag :: cabecera(usuario=${usuario})"></header>
<nav th:replace="components/menuLateral :: navbar"></nav>

<div class="container" style="margin-top: 150px;">
    <br><br>
    <div class="row">
        <div class="col-3"></div>
        <div class="card col-6 ">
            <div class="card-body">

                <h1 class="card-title" th:text="${ejercicio.getTitulo()}">Título del ejercicio</h1>
                <p class="card-text enunciado" th:text="${ejercicio.getDescripcion()}">Descripción del ejercicio</p>
                <img class="card-img img-fluid mb-3" th:if="${ejercicio.getImagen() != null}"
                     th:src="@{${ejercicio.getImagenPath()}}" height="138" width="580" alt="<Code picture>"/>
                <div id="myForm" class="was-validated">
                    <input type="hidden" id="resultMessageInput" name="resultMessage" th:value="${resultMessage}"/>
                    <input type="hidden" id="id_usuario" th:value="${id_usuario}"/>
                    <input type="hidden" id="id_ejercicio" th:value="${ejercicio.getId()}"/>
                    <input type="hidden" id="idNextEjer" th:value="${idNextEjer}"/>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="answer" value="1" id="op1" required
                               th:value="${ejercicio.getOpcion1()}"/>
                        <label class="respuestas" type="form-check-label" for="op4" th:text="${ejercicio.getOpcion1()}">Option 1</label>
                    </div>
                    <br/>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="answer" value="2" id="op2" required
                               th:value="${ejercicio.getOpcion2()}"/>
                        <label class="respuestas" type="form-check-label" for="op4" th:text="${ejercicio.getOpcion2()}">Option 2</label>
                    </div>
                    <br/>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="answer" value="3" id="op3" required
                               th:value="${ejercicio.getOpcion3()}"/>
                        <label class="respuestas" type="form-check-label" for="op4" th:text="${ejercicio.getOpcion3()}">Option 3</label>
                    </div>
                    <br/>
                    <div class="form-check">
                        <input type="radio" class="form-check-input" name="answer" value="4" id="op4" required
                               th:value="${ejercicio.getOpcion4()}"/>
                        <label class="respuestas" type="form-check-label" for="op4" th:text="${ejercicio.getOpcion4()}">Option 4</label>
                    </div>
                    <br/>
                    <button type="button"
                            class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#resultModal">Comprueba tu
                        respuesta
                    </button>
                </div>
            </div>
        </div>
        <div class="col-3">
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="margin-top: 150px; ">
        <div class="modal-content">
            <div class="modal-header" id="resultModalheader">
                <div class="row">
                    <div class="col-4"></div>
                    <div class="col-6">
                        <h1 class="modal-title" id="resultModalLabel">Resultado</h1>
                    </div>
                    <div class="col-2"></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="resultModalBack">
                <br><br>

                <div class="row">
                    <div class="col-2"></div>
                    <div class="modaltxt col-8 " id="resultMessage">ResultMessage</div>
                    <div class="col-2"></div>
                </div>

                <br><br>

                <div class="row">
                    <div class="col-2"></div>
                    <img class="col-8 oso" id="resultImage" width="200px" >
                    <div class="col-2"></div>
                </div>

                <br><br>

            </div>

            <div class="modal-footer" id="resultModalfooter">
                <div id="failedButton"></div>
                <div id="nextEjercicio"></div>
                <a th:href="@{/ejercicios}" class="btn btn-secondary">Volver al menú</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"
        integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3"
        crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
        integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V"
        crossorigin="anonymous"></script>
<script>
    document.getElementById('resultModal').addEventListener('show.bs.modal', event => {
        let resp = document.querySelector('input[name=answer]:checked');
        if (!resp) {
            const resultMessage = document.getElementById("resultMessage");
            resultMessage.innerHTML = "Debe indicar una respuesta.";
            return
        }
        resp = resp.value;
        const id_usuario = document.getElementById("id_usuario").value;
        const ejercicioId = document.getElementById("id_ejercicio").value;

        let formData = new FormData();
        formData.append('resp', resp);
        formData.append('id_usuario', id_usuario);
        let init = {
            method: 'POST',
            body: formData
        };

        fetch(ejercicioId + "/respuesta/save", init).then(function (response) {
            return response.text();
        }).then(function (html) {
            //Controla el mensaje del modal
            const resultMessage = document.getElementById("resultMessage");
            resultMessage.innerHTML = html;

            const respuestaCorrecta = "¡Muy bien! Tu respuesta es correcta.";
            const respuestaIncorrecta = "¡OH NO! Tu respuesta no es correcta. \n ¡Vuélvelo a intentar!";

            //Controla la imagen que se muestra en el modal
            const resultImage = document.getElementById("resultImage");
            if (resultMessage.textContent.trim() === respuestaCorrecta) {
                resultImage.src = "/image/oso_ok.png";
            } else {
                resultImage.src = "/image/error_kossito.png";
            }

            //Controla el fondo del modal
            const resultModalBack = document.getElementById("resultModalBack");
            if (resultMessage.textContent.trim() === respuestaCorrecta) {
                resultModalBack.style.backgroundImage = "url('/image/bien.png')";
            } else {
                resultModalBack.style.backgroundImage = "url('/image/mal.png')";
            }

             const resultModalheader = document.getElementById("resultModalheader");
            if (resultMessage.textContent.trim() === respuestaCorrecta) {
               resultModalheader.style.backgroundImage = "url('/image/bien70.png')";
            } else {
                resultModalheader.style.backgroundImage = "url('/image/mal70.png')";
            }

             const resultModalfooter = document.getElementById("resultModalfooter");
            if (resultMessage.textContent.trim() === respuestaCorrecta) {
              resultModalfooter.style.backgroundImage = "url('/image/bien70.png')";
            } else {
               resultModalfooter.style.backgroundImage = "url('/image/mal70.png')";
            }

            //Controla el botón de volver a intentar en el modal
            const failedButton = document.getElementById("failedButton");
            if (resultMessage.textContent.trim() === respuestaIncorrecta) {
                const tryAgainButton = document.getElementById("tryAgainButton");
                if (tryAgainButton) {
                    tryAgainButton.parentNode.removeChild(tryAgainButton);
                }

                const button = document.createElement("button");
                button.textContent = "Vuélvelo a intentar";
                button.setAttribute("class", "btn btn-primary");
                button.setAttribute("id", "tryAgainButton");
                button.setAttribute("data-bs-dismiss", "modal");
                failedButton.appendChild(button);
            } else {
                const tryAgainButton = document.getElementById("tryAgainButton");
                if (tryAgainButton) {
                    tryAgainButton.parentNode.removeChild(tryAgainButton);
                }
            }

            //Controla el botón de siguiente ejercicio en el modal
            const idNextEjer = document.getElementById("idNextEjer").value;

            const nextEjercicio = document.getElementById("nextEjercicio");
            if (resultMessage.textContent.trim() === respuestaCorrecta) {
             const nextButton = document.getElementById("nextButton");
                if (nextButton) {
                    nextButton.parentNode.removeChild(nextButton);
                }
                const button = document.createElement("button");
                button.textContent = "Siguiente";
                button.setAttribute("class", "btn btn-primary");
                button.setAttribute("id", "nextButton");
                button.setAttribute("onclick", `window.location.href = '/ejercicios/${idNextEjer}';`);
                nextEjercicio.appendChild(button);
            } else {
                const nextButton = document.getElementById("nextButton");
                if (nextButton) {
                    nextButton.parentNode.removeChild(nextButton);
                }
            }

        }).catch(function (err) {
            console.warn('Something went wrong.', err);
        });
    })

</script>
</body>

</html>